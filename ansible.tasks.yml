---
version: "3"

env:
  ANSIBLE_CONFIG: "{{.USER_WORKING_DIR}}/ansible.cfg"

vars:
  ANSIBLE_ARGS: ""

tasks:
  install:
    desc: "Install dependencies"
    cmds:
      - pip install -r requirements.txt
      - task: galaxy

  inventory:
    desc: "List all inventory hosts"
    cmds:
      - ansible-inventory --graph

  galaxy:
    desc: "Install roles and collections from Ansible Galaxy"
    cmds:
      - task: galaxy:clean
      - ansible-galaxy install -p {{.USER_WORKING_DIR}}/roles_galaxy -r {{.USER_WORKING_DIR}}/requirements.yml
      - ansible-galaxy collection install -p {{.USER_WORKING_DIR}}/collections -r {{.USER_WORKING_DIR}}/requirements.yml

  galaxy:clean:
    desc: "Clean roles and collections installed from Ansible Galaxy"
    cmds:
      - rm -rf roles_galaxy/*
      - rm -rf collections/*

  lint:
    desc: "Check syntax"
    cmds:
      - ansible-lint *

  ping:
    desc: "Ping all nodes"
    cmds:
      - ansible --one-line -m ping

  playbook:
    desc: "Run an Ansible playbook by name"
    cmds:
      - ansible-playbook {{.CLI_ARGS}}

  playbook:debug:
    desc: "Run an Ansible playbook by name with maximum debugging"
    cmds:
      - ansible-playbook -vvvv {{.CLI_ARGS}}
